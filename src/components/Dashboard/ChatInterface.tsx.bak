import React, { useState, useEffect, useRef } from 'react';
import { Send, Bot, User, Loader2 } from 'lucide-react';
import type { ProcessedFile } from '../../services/fileProcessor';
import ReactMarkdown from 'react-markdown';
import { callGemini, type ChatMessage } from '../../services/gemini';

interface ChatInterfaceProps {
    files: ProcessedFile[];
    onOpenSettings: () => void;
    onShowReport: (data: any) => void;
    user?: any;
    messages: ChatMessage[];
    onMessagesChange: (messages: ChatMessage[]) => void;
}

export const ChatInterface: React.FC<ChatInterfaceProps> = ({
    files,
    onShowReport,
    user,
    messages,
    onMessagesChange
}) => {
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    const messagesEndRef = useRef<HTMLDivElement>(null);
    const textareaRef = useRef<HTMLTextAreaElement>(null);

    const scrollToBottom = () => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    };

    useEffect(() => {
        scrollToBottom();
    }, [messages]);

    // Auto-resize textarea
    useEffect(() => {
        if (textareaRef.current) {
            textareaRef.current.style.height = 'auto';
            textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 150)}px`;
        }
    }, [input]);

    // Generate smart suggestions based on file content
    const [smartSuggestions, setSmartSuggestions] = useState<string[]>([]);

    useEffect(() => {
        if (files.length === 0) {
            setSmartSuggestions([]);
            return;
        }

        const newSuggestions: string[] = [];

        files.forEach(f => {
            // Check if file has any active sheets
            const activeSheets = f.sheets.filter(s => s.isActive !== false);

            if (activeSheets.length === 0) return;

            activeSheets.forEach(s => {
                const headers = s.headers.map(h => h.toLowerCase());

                // Time-based analysis
                if (headers.some(h => h.includes('fecha') || h.includes('date') || h.includes('time') || h.includes('año') || h.includes('mes'))) {
                    newSuggestions.push(`Analiza la tendencia temporal en ${s.name}`);
                }

                // Financial/Numerical analysis
                if (headers.some(h => h.includes('venta') || h.includes('precio') || h.includes('costo') || h.includes('total') || h.includes('amount') || h.includes('revenue'))) {
                    newSuggestions.push(`Reporte de ingresos para ${s.name}`);
                }

                // Categorical analysis
                if (headers.some(h => h.includes('categoria') || h.includes('tipo') || h.includes('estado') || h.includes('status') || h.includes('grupo'))) {
                    newSuggestions.push(`Distribución por categorías en ${s.name}`);
                }
            });
        });

        // Deduplicate and limit
        const unique = [...new Set(newSuggestions)].slice(0, 4);

        if (unique.length > 0) {
            setSmartSuggestions(unique);
        } else {
            // Fallback generic suggestions
            setSmartSuggestions([
                "Genera un reporte visual de los datos",
                "Identifica los 3 hallazgos más importantes",
                "Resume la estructura de los archivos cargados"
            ]);
        }
    }, [files]);

    const handleSend = async (e?: React.FormEvent, overrideInput?: string) => {
        if (e) e.preventDefault();
        const textToSend = overrideInput || input;
        if (!textToSend.trim()) return;

        const userMsg: ChatMessage = { role: 'user', text: textToSend };
        const newMessages = [...messages, userMsg];
        onMessagesChange(newMessages);
        setInput('');
        if (textareaRef.current) textareaRef.current.style.height = 'auto';

        const isReportRequest = textToSend.toLowerCase().includes('reporte') || textToSend.toLowerCase().includes('infografía') || textToSend.toLowerCase().includes('visual');
        const apiKey = localStorage.getItem('geminiApiKey');

        // Construct context from files
        let context = "";
        if (files.length > 0) {
            context = "Contexto de datos (Resumen Estadístico):\n";
            files.forEach(f => {
                f.sheets.forEach(s => {
                    if (s.isActive === false) return; // Skip inactive sheets
                    context += `\nArchivo: ${f.name}, Hoja: ${s.name}\n`;

                    // 1. Column Metadata & Stats
                    const stats = s.headers.map((header) => {
                        const values = s.data.map(row => row[header]).filter(v => v !== null && v !== undefined && v !== '');

                        // Determine type
                        const isNumeric = values.every(v => !isNaN(Number(v)));
                        let statStr = `Columna: ${header} (${isNumeric ? 'Numérica' : 'Texto'})`;

                        if (isNumeric && values.length > 0) {
                            const nums = values.map(v => Number(v));
                            const min = Math.min(...nums);
                            const max = Math.max(...nums);
                            const avg = nums.reduce((a, b) => a + b, 0) / nums.length;
                            statStr += ` Min: ${min.toFixed(2)}, Max: ${max.toFixed(2)}, Promedio: ${avg.toFixed(2)}`;
                        } else if (values.length > 0) {
                            // Top 3 frequent values for text
                            const counts: Record<string, number> = {};
                            values.forEach(v => counts[String(v)] = (counts[String(v)] || 0) + 1);
                            const top3 = Object.entries(counts)
                                .sort((a, b) => b[1] - a[1])
                                .slice(0, 3)
                                .map(([k, v]) => `${k} (${v})`)
                                .join(', ');
                            statStr += ` Top valores: ${top3}`;
                            const systemPrompt = `
Eres un experto analista de datos y Director de Arte de Información. Tu misión es analizar los datos proporcionados y diseñar un "blueprint" (plano) para un reporte visual de alto impacto (Infografía).

TU OBJETIVO:
Contar la historia más importante oculta en los datos. No solo muestres números, explica el "por qué" y el "qué significa".

ESTRUCTURA DE RESPUESTA (JSON):
Debes devolver EXCLUSIVAMENTE un objeto JSON válido con la siguiente estructura:

{
  "infographic": [
    {
      "type": "header",
      "title": "Título Impactante y Descriptivo",
      "subtitle": "Subtítulo que resume la conclusión principal"
    },
    {
      "type": "kpi_grid",
      "items": [
        { "label": "Métrica Clave", "value": "Valor", "trend": "up/down/neutral", "trendValue": "+10% vs mes anterior" }
      ]
    },
    {
      "type": "layout_2_col",
      "children": [
        {
          "type": "chart",
          "chartType": "bar",
          "title": "Título del Gráfico",
          "analysisText": "Breve interpretación de lo que muestra este gráfico.",
          "chartData": { 
            "labels": ["A", "B"], 
            "datasets": [{ 
              "label": "Dataset", 
              "data": [10, 20],
              "backgroundColor": "rgba(0, 240, 181, 0.7)",
              "borderColor": "#00F0B5",
              "borderWidth": 2
            }] 
          }
        },
        {
          "type": "alert_list",
          "title": "Hallazgos Críticos",
          "items": [
             { "text": "Título: Descripción del hallazgo", "severity": "critical" }
          ]
        }
      ]
    },
    {
      "type": "data_table",
      "title": "Top 5 Registros Relevantes",
      "headers": ["Col1", "Col2"],
      "rows": [ ["Val1", "Val2"] ]
    }
  ]
}

REGLAS DE DISEÑO:
1. Usa "layout_2_col" para agrupar gráficos y listas de alertas/hallazgos lado a lado.
2. Sé selectivo. No grafiques todo. Grafica lo que importa.
3. Los textos de análisis deben ser perspicaces, no descriptivos ("Las ventas cayeron por X" vs "Las ventas bajaron").
4. Si el usuario pide algo específico, priorízalo. Si no, encuentra la historia más valiosa.
5. **CRÍTICO - DATOS Y PORCENTAJES:**
   - Usa EXACTAMENTE los datos proporcionados. NO inventes, redondees arbitrariamente, ni extrapoles.
   - Para gráficos que comparan proporciones/distribuciones: CONVIERTE a porcentajes para claridad visual
   - Para gráficos de tendencias temporales o valores absolutos: usa los valores originales
   - Si un valor absoluto es muy grande (ej. 1,234,567), muéstralo como está pero considera agregar contexto interpretativo
   - NUNCA generes datos ficticios para "completar" un gráfico

CONTEXTO DE DATOS:
${context}
`;

                            if (!apiKey) {
                                onMessagesChange([...newMessages, {
                                    role: 'model',
                                    text: 'Por favor, configura tu API Key de Gemini en los ajustes para continuar.'
                                }]);
                                setLoading(false);
                                return;
                            }

                            setLoading(true);

                            try {
                                const response = await callGemini([...newMessages], systemPrompt, apiKey, isReportRequest);

                                if (response) {
                                    // Try to parse as JSON first if it looks like a report
                                    try {
                                        const cleanResponse = response.replace(/```json/g, '').replace(/```/g, '').trim();
                                        const json = JSON.parse(cleanResponse);

                                        if (json.infographic) {
                                            // Validate report before showing
                                            // Notify parent to save to history
                                            onShowReport(fixed);

                                            onMessagesChange([...newMessages, {
                                                role: 'model',
                                                text: '¡Reporte generado! He creado una visualización con los datos analizados.',
                                                reportId: reportId
                                            }]);

                                            window.open('/#/report-view', '_blank', 'width=1280,height=800');
                                        } else {
                                            console.error('❌ No se pudo corregir el reporte:', revalidation.errors);
                                            onMessagesChange([...newMessages, {
                                                role: 'model',
                                                text: `⚠️ El reporte tiene errores de calidad. Por favor, intenta de nuevo con más contexto.\n\nErrores: ${revalidation.errors.map(e => e.message).join(', ')}`
                                            }]);
                                            return;
                                        }
                                    } else {
                                        console.log('✅ Reporte válido');
                                        const reportId = crypto.randomUUID();
                                        const reportWithId = { ...json, id: reportId };

                                        // Save to localStorage for immediate view
                                        localStorage.setItem('currentReport', JSON.stringify(reportWithId));

                                        // Notify parent to save to history
                                        onShowReport(json);

                                        onMessagesChange([...newMessages, {
                                            role: 'model',
                                            text: '¡Reporte generado! He creado una visualización con los datos analizados.',
                                            reportId: reportId
                                        }]);

                                        window.open('/#/report-view', '_blank', 'width=1280,height=800');
                                    }
                                    return;
                                }
                            } catch (e) {
                                console.error('Error parsing report JSON:', e);
                                // Not JSON, continue as text
                            }
                            onMessagesChange([...newMessages, { role: 'model', text: response }]);
                        }
                    } catch (error: any) {
                        onMessagesChange([...newMessages, { role: 'model', text: `Error: ${error.message}` }]);
                    } finally {
                        setLoading(false);
                    }
                };

                const handleSuggestionClick = (suggestion: string) => {
                    handleSend(undefined, suggestion);
                };
                const handleCreateReport = (e: React.MouseEvent) => {
                    e.preventDefault();
                    const reportPrompt = "Genera un reporte visual detallado sobre lo anterior";
                    handleSend(undefined, reportPrompt);
                };

                // Custom components for ReactMarkdown to improve styling
                const MarkdownComponents = {
                    h1: ({ node, ...props }: any) => <h1 className="text-xl font-bold mb-3 mt-4" {...props} />,
                    h2: ({ node, ...props }: any) => <h2 className="text-lg font-bold mb-2 mt-3" {...props} />,
                    h3: ({ node, ...props }: any) => <h3 className="text-md font-bold mb-2 mt-2" {...props} />,
                    p: ({ node, ...props }: any) => <p className="mb-3 leading-relaxed" {...props} />,
                    ul: ({ node, ...props }: any) => <ul className="list-disc list-inside mb-3 space-y-1" {...props} />,
                    ol: ({ node, ...props }: any) => <ol className="list-decimal list-inside mb-3 space-y-1" {...props} />,
                    li: ({ node, ...props }: any) => <li className="ml-2" {...props} />,
                    strong: ({ node, ...props }: any) => <strong className="font-bold" {...props} />,
                    table: ({ node, ...props }: any) => (
                        <div className="overflow-x-auto mb-4 rounded-lg border border-gray-200 dark:border-white/10">
                            <table className="min-w-full divide-y divide-gray-200 dark:divide-white/10" {...props} />
                        </div>
                    ),
                    thead: ({ node, ...props }: any) => <thead className="bg-gray-50 dark:bg-white/5" {...props} />,
                    tbody: ({ node, ...props }: any) => <tbody className="divide-y divide-gray-200 dark:divide-white/5 bg-transparent" {...props} />,
                    tr: ({ node, ...props }: any) => <tr className="hover:bg-gray-50 dark:hover:bg-white/5 transition-colors" {...props} />,
                    th: ({ node, ...props }: any) => <th className="px-4 py-3 text-left text-xs font-medium opacity-70 uppercase tracking-wider" {...props} />,
                    td: ({ node, ...props }: any) => <td className="px-4 py-3 text-sm whitespace-normal" {...props} />,
                };

                return (
                    <div className="flex flex-col h-full bg-dark-bg border-l border-dark-border flex-1">
                        <div className="p-4 border-b border-dark-border flex justify-between items-center bg-bg-secondary">
                            <h3 className="font-bold text-primary flex items-center gap-2">
                                <Bot className="w-5 h-5 text-brand" /> Asistente IA
                            </h3>
                        </div>

                        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                            {messages.length === 0 && (
                                <div className="text-center text-secondary mt-10">
                                    <Bot className="w-12 h-12 mx-auto mb-3 opacity-20" />
                                    <p className="text-sm mb-6">Haz preguntas sobre tus datos.</p>

                                    {smartSuggestions.length > 0 && (
                                        <div className="max-w-md mx-auto grid grid-cols-1 gap-2">
                                            <p className="text-xs text-gray-500 dark:text-secondary/70 uppercase tracking-wider mb-2">Sugerencias</p>
                                            {smartSuggestions.map((s, i) => (
                                                <button
                                                    key={i}
                                                    onClick={() => handleSuggestionClick(s)}
                                                    className="text-left p-3 rounded-lg bg-gray-50 dark:bg-white/5 hover:bg-gray-100 dark:hover:bg-white/10 border border-gray-200 dark:border-white/5 hover:border-brand/30 dark:hover:border-white/20 transition-all text-sm text-gray-700 dark:text-gray-300 hover:text-brand dark:hover:text-white"
                                                >
                                                    {s}
                                                </button>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            {messages.map((msg, idx) => (
                                <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'flex-row-reverse' : ''}`}>
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${msg.role === 'user' ? 'bg-chat-user-bg' : 'bg-bg-secondary'}`}>
                                        {msg.role === 'user' ? (
                                            <div className="flex items-center justify-center w-full h-full font-bold text-xs text-chat-user-text">
                                                {user?.user_metadata?.full_name ? user.user_metadata.full_name.charAt(0).toUpperCase() : (user?.email ? user.email.charAt(0).toUpperCase() : <User className="w-4 h-4" />)}
                                            </div>
                                        ) : <Bot className="w-4 h-4 text-primary" />}
                                    </div>
                                    <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${msg.role === 'user'
                                        ? 'bg-chat-user-bg text-chat-user-text rounded-tr-none'
                                        : 'bg-chat-bot-bg text-chat-bot-text rounded-tl-none'
                                        }`}>
                                        <ReactMarkdown components={MarkdownComponents}>{msg.text}</ReactMarkdown>

                                        {/* Show 'Open Report' button if message has a reportId */}
                                        {msg.reportId && (
                                            <div className="mt-3 pt-3 border-t border-white/10">
                                                <button
                                                    onClick={() => {
                                                        window.open('/#/report-view', '_blank', 'width=1280,height=800');
                                                    }}
                                                    className="w-full py-2 bg-brand hover:bg-brand-light text-white rounded-lg flex items-center justify-center gap-2 transition-colors font-medium shadow-lg shadow-brand/20"
                                                >
                                                    <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                                    Ver Reporte Completo
                                                </button>
                                            </div>
                                        )}

                                        {msg.role === 'model' && !msg.reportId && !msg.text.includes('¡Reporte generado!') && (
                                            <div className="mt-2 pt-2 border-t border-white/10 flex justify-end">
                                                <button
                                                    onClick={handleCreateReport}
                                                    className="text-xs flex items-center gap-1 text-brand-light hover:text-white transition-colors opacity-80 hover:opacity-100"
                                                    title="Generar reporte visual de esta respuesta"
                                                >
                                                    <span className="w-1.5 h-1.5 rounded-full bg-brand animate-pulse"></span>
                                                    Crear Reporte
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            ))}
                            {loading && (
                                <div className="flex gap-3">
                                    <div className="w-8 h-8 rounded-full bg-bg-secondary flex items-center justify-center">
                                        <Bot className="w-4 h-4 text-primary" />
                                    </div>
                                    <div className="bg-chat-bot-bg p-3 rounded-2xl rounded-tl-none">
                                        <Loader2 className="w-4 h-4 animate-spin text-chat-bot-text" />
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        <form onSubmit={handleSend} className="p-4 border-t border-dark-border bg-bg-secondary">
                            <div className="relative flex items-end gap-2">
                                <textarea
                                    ref={textareaRef}
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && !e.shiftKey) {
                                            e.preventDefault();
                                            handleSend();
                                        }
                                    }}
                                    placeholder="Escribe tu pregunta..."
                                    className="w-full bg-dark-bg border border-dark-border rounded-xl pl-4 pr-10 py-3 text-sm text-primary placeholder:text-secondary focus:ring-1 focus:ring-brand outline-none resize-none min-h-[44px] max-h-[150px] overflow-y-auto custom-scrollbar"
                                    disabled={loading}
                                    rows={1}
                                />
                                <button
                                    type="submit"
                                    disabled={!input.trim() || loading}
                                    className="absolute right-2 bottom-2 p-1.5 text-brand hover:bg-brand/10 rounded-lg transition-colors disabled:opacity-50"
                                >
                                    <Send className="w-4 h-4" />
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };
